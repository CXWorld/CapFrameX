<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:CapFrameX.App.ViewModels"
             xmlns:lvc="using:LiveChartsCore.SkiaSharpView.Avalonia"
             x:Class="CapFrameX.App.Views.CaptureView"
             x:DataType="vm:CaptureViewModel">

    <Grid ColumnDefinitions="300,*" Margin="15">
        <!-- Left Panel - Game Selection and System Info -->
        <Grid Grid.Column="0" RowDefinitions="*,Auto" Margin="0 0 10 0">
            <!-- Game Selection -->
            <Border Grid.Row="0" Background="#1E2A3A" CornerRadius="10" Padding="15" BorderBrush="#2A3F55" BorderThickness="1">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top" Text="Detected Games" FontSize="16" FontWeight="SemiBold" Margin="0 0 0 10" />

                    <StackPanel DockPanel.Dock="Bottom" Spacing="10" Margin="0 10 0 0">
                        <Button Content="{Binding CaptureButtonText}"
                            Command="{Binding ToggleCaptureCommand}"
                            IsEnabled="{Binding SelectedGame, Converter={x:Static ObjectConverters.IsNotNull}}"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            Padding="0 12"
                            FontSize="14"
                            Classes.capturing="{Binding IsCapturing}">
                        <Button.Styles>
                            <Style Selector="Button.capturing">
                                <Setter Property="Background" Value="#E74C3C" />
                                <Setter Property="Foreground" Value="White" />
                            </Style>
                            <Style Selector="Button:not(.capturing)">
                                <Setter Property="Background" Value="#4AA3DF" />
                                <Setter Property="Foreground" Value="White" />
                            </Style>
                        </Button.Styles>
                    </Button>
                </StackPanel>

                <ListBox ItemsSource="{Binding DetectedGames}"
                         SelectedItem="{Binding SelectedGame}"
                         Background="Transparent">
                    <ListBox.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Add to Ignore List"
                                      Command="{Binding AddToIgnoreListCommand}"
                                      CommandParameter="{Binding SelectedGame}" />
                        </ContextMenu>
                    </ListBox.ContextMenu>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Margin="5">
                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                                <TextBlock Text="{Binding Launcher, StringFormat='via {0}'}"
                                           FontSize="11" Opacity="0.7"
                                           IsVisible="{Binding Launcher, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                                <TextBlock Text="{Binding Pid, StringFormat='PID: {0}'}"
                                           FontSize="11" Opacity="0.5" />
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </DockPanel>
        </Border>

            <!-- System Info Panel -->
            <Border Grid.Row="1" Background="#1E2A3A" CornerRadius="10" Padding="15" Margin="0 10 0 0" BorderBrush="#2A3F55" BorderThickness="1">
                <StackPanel Spacing="8">
                    <TextBlock Text="System Info" FontSize="14" FontWeight="SemiBold" Foreground="#4AA3DF" Margin="0 0 0 5" />

                    <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" Margin="0">
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="CPU" FontSize="11" Opacity="0.6" Margin="0 0 10 4" />
                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SystemInfo.CpuName}" FontSize="11" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding SystemInfo.CpuName}" />

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Cores" FontSize="11" Opacity="0.6" Margin="0 0 10 4" />
                        <TextBlock Grid.Row="1" Grid.Column="1" FontSize="11">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="{}{0}C / {1}T">
                                    <Binding Path="SystemInfo.CpuCores" />
                                    <Binding Path="SystemInfo.CpuThreads" />
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="RAM" FontSize="11" Opacity="0.6" Margin="0 0 10 4" />
                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SystemInfo.TotalRam}" FontSize="11" />

                        <TextBlock Grid.Row="3" Grid.Column="0" Text="GPU" FontSize="11" Opacity="0.6" Margin="0 0 10 4" />
                        <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding SystemInfo.GpuName}" FontSize="11" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding SystemInfo.GpuName}" />

                        <TextBlock Grid.Row="4" Grid.Column="0" Text="iGPU" FontSize="11" Opacity="0.6" Margin="0 0 10 4"
                                   IsVisible="{Binding SystemInfo.HasIgpu}" />
                        <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding SystemInfo.IgpuName}" FontSize="11" TextTrimming="CharacterEllipsis"
                                   ToolTip.Tip="{Binding SystemInfo.IgpuName}" IsVisible="{Binding SystemInfo.HasIgpu}" />

                        <TextBlock Grid.Row="5" Grid.Column="0" Text="Board" FontSize="11" Opacity="0.6" Margin="0 0 10 0" />
                        <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding SystemInfo.Motherboard}" FontSize="11" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding SystemInfo.Motherboard}" />
                    </Grid>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Right Panel - Live Stats and Chart -->
        <Grid Grid.Column="1" RowDefinitions="Auto,*">
            <!-- Statistics Cards -->
            <WrapPanel Grid.Row="0" Margin="0 0 0 10">
                <Border Background="#1E2A3A" CornerRadius="10" Padding="20 15" Margin="0 0 10 10" MinWidth="120" BorderBrush="#2A3F55" BorderThickness="1">
                    <StackPanel>
                        <TextBlock Text="FPS" FontSize="12" Foreground="#4AA3DF" />
                        <TextBlock Text="{Binding CurrentFps, StringFormat='{}{0:F1}'}" FontSize="28" FontWeight="Bold" />
                    </StackPanel>
                </Border>

                <Border Background="#1E2A3A" CornerRadius="10" Padding="20 15" Margin="0 0 10 10" MinWidth="120" BorderBrush="#2A3F55" BorderThickness="1">
                    <StackPanel>
                        <TextBlock Text="1% Low" FontSize="12" Foreground="#4AA3DF" />
                        <TextBlock Text="{Binding P1LowFps, StringFormat='{}{0:F1}'}" FontSize="28" FontWeight="Bold" />
                    </StackPanel>
                </Border>

                <Border Background="#1E2A3A" CornerRadius="10" Padding="20 15" Margin="0 0 10 10" MinWidth="120" BorderBrush="#2A3F55" BorderThickness="1">
                    <StackPanel>
                        <TextBlock Text="0.1% Low" FontSize="12" Foreground="#4AA3DF" />
                        <TextBlock Text="{Binding P01LowFps, StringFormat='{}{0:F1}'}" FontSize="28" FontWeight="Bold" />
                    </StackPanel>
                </Border>

                <Border Background="#1E2A3A" CornerRadius="10" Padding="20 15" Margin="0 0 10 10" MinWidth="120" BorderBrush="#2A3F55" BorderThickness="1">
                    <StackPanel>
                        <TextBlock Text="Frames" FontSize="12" Foreground="#4AA3DF" />
                        <TextBlock Text="{Binding FrameCount}" FontSize="28" FontWeight="Bold" />
                    </StackPanel>
                </Border>

                <Border Background="#1E2A3A" CornerRadius="10" Padding="20 15" Margin="0 0 10 10" MinWidth="120" BorderBrush="#2A3F55" BorderThickness="1">
                    <StackPanel>
                        <TextBlock Text="Duration" FontSize="12" Foreground="#4AA3DF" />
                        <TextBlock Text="{Binding CaptureDuration}" FontSize="28" FontWeight="Bold" />
                    </StackPanel>
                </Border>

                <Border Background="#1E2A3A" CornerRadius="10" Padding="20 15" Margin="0 0 10 10" MinWidth="120" BorderBrush="#2A3F55" BorderThickness="1">
                    <StackPanel>
                        <TextBlock Text="Avg Frametime" FontSize="12" Foreground="#4AA3DF" />
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{Binding AverageFrametime, StringFormat='{}{0:F2}'}" FontSize="28" FontWeight="Bold" />
                            <TextBlock Text="ms" FontSize="14" VerticalAlignment="Bottom" Margin="4 0 0 5" Opacity="0.7" />
                        </StackPanel>
                    </StackPanel>
                </Border>
            </WrapPanel>

            <!-- Live Chart -->
            <Border Grid.Row="1" Background="#1E2A3A" CornerRadius="10" Padding="15" BorderBrush="#2A3F55" BorderThickness="1">
                <lvc:CartesianChart Series="{Binding FrametimeSeries}"
                                    XAxes="{Binding XAxes}"
                                    YAxes="{Binding YAxes}"
                                    TooltipPosition="Hidden"
                                    ZoomMode="X" />
            </Border>
        </Grid>
    </Grid>
</UserControl>
